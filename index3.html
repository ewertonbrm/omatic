<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch O' Matic - Base Hamlet</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192x192.png"> 

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Importa a fonte para simular o display do pager */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        /* Definindo as cores do tema (Unificado com o index.html e index2.html) */
        :root {
            --pager-green: #ADD657; /* Verde limão clássico de pager */
            --pager-black: #000000;
        }

        body {
            font-family: 'VT323', monospace; /* Fonte monoespaçada para simular o pager */
            background-color: var(--pager-green); /* Fundo verde limão */
            color: var(--pager-black); /* Texto preto */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1); /* Sombra para dar profundidade ao texto */
        }

        /* Container principal: Sem sombra, como um pager simples */
        .container {
            background-color: var(--pager-green); /* Fundo verde limão */
            border: 5px solid var(--pager-black); /* Borda preta grossa */
            border-radius: 8px; /* Cantos levemente arredondados */
            box-shadow: 8px 8px 0px -2px rgba(0,0,0,0.5); /* Sombra dura para efeito 3D antigo */
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        /* Estilo para inputs */
        input {
            background-color: var(--pager-green); /* Fundo verde limão */
            color: var(--pager-black); /* Texto preto */
            border: 2px solid var(--pager-black); /* Borda preta */
            border-radius: 4px;
            padding: 0.75rem 1rem;
            font-size: 1.25rem;
            line-height: 1.5;
            text-align: center;
        }

        /* Foco dos inputs: Borda preta sólida, sem ring glow */
        input:focus {
            outline: none;
            border-color: var(--pager-black);
            box-shadow: none;
        }

        /* Input Group */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        @media (min-width: 640px) {
            .input-group {
                flex-direction: row;
            }
        }

        /* Botão de Download */
        #downloadButton {
            background-color: var(--pager-black); /* Fundo preto */
            color: var(--pager-green); /* Texto verde limão */
            font-size: 1.25rem; 
            font-weight: bold;
            padding: 0.75rem 1rem;
            border: 2px solid var(--pager-green); /* Borda verde limão */
            border-radius: 4px;
            box-shadow: 4px 4px 0px -1px rgba(0,0,0,0.5); /* Sombra dura */
            cursor: pointer;
            transition: background-color 0.1s;
        }

        #downloadButton:hover {
            background-color: #333333; /* Levemente mais claro no hover */
            color: #adff2f; /* Verde mais vibrante no hover */
        }
        #downloadButton:active {
            box-shadow: 2px 2px 0px -1px rgba(0,0,0,0.5); /* Sombra menor no active */
            transform: translateY(2px) translateX(2px); /* Efeito de clique */
        }
        #downloadButton:disabled {
            background-color: #333333;
            color: #666666;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Botão Voltar (Novo) */
        #backButton {
            background-color: #000000;
            color: var(--pager-green);
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--pager-black);
            border-radius: 4px;
            box-shadow: 2px 2px 0px -1px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: background-color 0.1s;
        }

        /* Status Message */
        #statusMessage {
            font-size: 1.125rem;
            font-weight: bold;
            min-height: 1.5rem;
            text-transform: uppercase;
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); /* Fundo semi-transparente preto */
        }

        .modal-content {
            background-color: var(--pager-green);
            margin: 10% auto; /* 10% do topo e centralizado */
            padding: 2rem;
            border: 5px solid var(--pager-black);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 8px 8px 0px -2px rgba(0,0,0,0.5);
            text-align: left;
        }

        .close-button {
            color: var(--pager-black);
            font-size: 3rem;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff0000;
            text-decoration: none;
            cursor: pointer;
        }

        #cheatContentPreview {
            width: 100%;
            min-height: 300px;
            background-color: var(--pager-green); 
            border: 2px solid var(--pager-black);
            font-size: 1rem;
            padding: 1rem;
            resize: none;
            margin-top: 1rem;
        }

        .warning-text {
            color: #ff0000; /* Texto de aviso em vermelho */
            font-weight: bold;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        #confirmDownloadButton {
            background-color: #008000; /* Verde forte para destaque */
            color: var(--pager-green);
            font-size: 1.25rem;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border: 2px solid var(--pager-green);
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 4px 4px 0px -1px rgba(0,0,0,0.5);
            width: 100%;
        }

    </style>
</head>
<body class="selection:bg-pager-black selection:text-pager-green">
    <div class="absolute top-4 left-4">
        <button id="backButton" onclick="window.location.href='index.html'">MENU</button>
    </div>

    <div class="container">
        <h1 class="text-5xl font-bold uppercase mb-2 leading-none">
                SWITCH O' MATIC
            </h1>
        <p class="text-lg">-- BASE DE CHEATS HAMLETDUFROMAGE --</p>

        <div class="input-group">
            <label for="gameIdInput" class="block text-base font-bold uppercase mb-1">ID DO JOGO (16 DIGITOS HEX)</label>
            <input type="text" id="gameIdInput" placeholder="EX: 01007E300B7B8000" maxlength="16" class="flex-grow">
            <button id="downloadButton">BUSCAR E BAIXAR CHEATS (.TXT)</button>
        </div>

        <p id="statusMessage" class="status"></p>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closePreview">&times;</span>
            <h2>PRÉ-VISUALIZAÇÃO DO CHEAT</h2>
            <textarea id="cheatContentPreview" readonly></textarea>
            <p class="warning-text">CONFIRME A FORMATAÇÃO ANTES DE BAIXAR.</p>
            <button id="confirmDownloadButton">CONFIRMAR E BAIXAR (.TXT)</button>
        </div>
    </div>

    <script>
        // --- Constantes e Elementos ---
        const inputElement = document.getElementById('gameIdInput');
        const downloadButton = document.getElementById('downloadButton');
        const statusElement = document.getElementById('statusMessage');

        // Elementos do Modal
        const previewModal = document.getElementById('previewModal');
        const closePreviewButton = document.getElementById('closePreview');
        const previewTextArea = document.getElementById('cheatContentPreview');
        const confirmDownloadButton = document.getElementById('confirmDownloadButton');
        
        // Variável global para armazenar o conteúdo a ser baixado
        let currentCheatContent = { text: null, id: null }; 

        // --- Event Listeners ---
        downloadButton.addEventListener('click', handleDownload);
        closePreviewButton.addEventListener('click', () => {
            previewModal.style.display = 'none';
        });
        confirmDownloadButton.addEventListener('click', () => {
            if (currentCheatContent.text) {
                iniciarDownload(currentCheatContent.text, currentCheatContent.id);
            }
            previewModal.style.display = 'none';
        });
        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target == previewModal) {
                previewModal.style.display = 'none';
            }
        }
        
        // --- FUNÇÕES DE LÓGICA ---

        // Função auxiliar para formatar o JSON em texto limpo (mantendo colchetes nos nomes)
        function formatJsonToSwitchCheatTxt(cheatData, gameId) {
            let output = '';
            let gameTitle = 'UNKNOWN GAME TITLE';
            
            // 1. Encontrar todas as chaves que são Build IDs (16 dígitos hex)
            const buildIdKeys = Object.keys(cheatData).filter(key => key.length === 16 && key.match(/^[0-9A-F]+$/i));
            
            // --- CÓDIGO DE TRATAMENTO DE ERRO/FALLBACK ---
            if (buildIdKeys.length === 0) {
                output += `ERRO: NAO FOI POSSIVEL IDENTIFICAR NENHUM BLOCO DE CHEATS (BUILD ID) NO JSON.\n`;
                output += `VERIFIQUE O FORMATO DO ARQUIVO.\n\n`;
                gameTitle = gameId;
                output += `[${gameTitle}]\n`;
                output += `[${gameId}]\n\n`;
                output += '--- CONTEUDO JSON BRUTO (FALLBACK) ---\n';
                return output + JSON.stringify(cheatData, null, 2).toUpperCase();
            }

            // 2. Tenta obter o nome do jogo
            if (cheatData.attribution) {
                // Tenta extrair o nome do jogo da chave de atribuição mais provável
                const longKey = Object.keys(cheatData.attribution).find(key => key.includes('ver'));
                if (longKey) {
                     gameTitle = longKey.split(' ver ')[0].trim().toUpperCase();
                } else if (cheatData.attribution["WARRIORS OROCHI 4.txt"]) {
                    gameTitle = "WARRIORS OROCHI 4";
                }
            } else {
                 gameTitle = gameId; // Usa o ID do jogo como título se nada for encontrado
            }

            // 3. Adicionar Título do Jogo e ID (Formato EdiZon)
            output += `[${gameTitle}]\n`;
            output += `[${gameId}]\n\n`;
            
            // 4. Adicionar Informações de Atribuição (Inclui o texto completo da atribuição)
            if (cheatData.attribution) {
                output += `--- ATRIBUICAO COMPLETA (CRÉDITOS E FONTES) ---\n\n`;
                for (const key in cheatData.attribution) {
                    if (cheatData.attribution.hasOwnProperty(key)) {
                        output += `[FONTE/ARQUIVO: ${key.toUpperCase()}]\n`;
                        // Adiciona o conteúdo do attribution com todas as quebras de linha preservadas
                        output += `${cheatData.attribution[key].toUpperCase().trim()}\n\n`;
                    }
                }
                output += `----------------------------------------------\n\n`;
            }

            // 5. Adicionar Notas Gerais (se houver)
            if (cheatData.notes) {
                output += `--- NOTAS GERAIS ---\n`;
                output += `${cheatData.notes.toUpperCase().trim()}\n`;
                output += `--------------------\n\n`;
            }

            // 6. Iterar sobre TODOS os blocos de Build ID e formatar os cheats
            buildIdKeys.forEach(buildId => {
                const cheats = cheatData[buildId];
                output += `--- CHEATS (BUILD ID: ${buildId.toUpperCase()}) ---\n\n`;
                
                for (const cheatNameWithBrackets in cheats) {
                    if (cheats.hasOwnProperty(cheatNameWithBrackets)) {
                        let cheatContent = cheats[cheatNameWithBrackets];
                        
                        // 1. Adiciona o nome do cheat (MAIÚSCULAS) - Titulo limpo.
                        output += `${cheatNameWithBrackets.toUpperCase()}\n`; 
                        
                        // 2. Remove o nome do cheat duplicado encontrando a primeira quebra de linha.
                        const firstNewlineIndex = cheatContent.indexOf('\n');
                        let contentWithoutTitle = '';

                        if (firstNewlineIndex !== -1) {
                            // Pega a string a partir do caractere após a primeira quebra de linha (removendo o título).
                            contentWithoutTitle = cheatContent.substring(firstNewlineIndex + 1).trimStart();
                        }
                        // O .trimStart() é usado aqui para remover possíveis espaços em branco extras no início do código, 
                        // mas não remove as quebras de linha internas que você deseja manter.

                        // 3. Adiciona o conteúdo restante (apenas códigos/instruções)
                        // Apenas converte para MAIÚSCULAS e adiciona uma linha em branco para separar os blocos.
                        output += `${contentWithoutTitle.toUpperCase()}\n\n`;
                    }
                }
                output += `\n`; // Adiciona uma linha em branco após cada bloco de Build ID
            });


            return output.trim();
        }

        // Função para executar o download
        function iniciarDownload(cheatContentText, gameId) {
            const outputFileName = `${gameId}.txt`;
            
            // Cria Blob e URL para forçar o download como .txt
            const blob = new Blob([cheatContentText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFileName; 
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            statusElement.textContent = `✅ SUCESSO! O DOWNLOAD DO ARQUIVO ${outputFileName} FOI INICIADO.`;
        }

        // Função que busca e exibe o modal de visualização
        async function buscarEVisualizarCheat(gameId) {
            const fileNameJson = `${gameId}.json`;
            // URL CORRIGIDA: Utilizando 'master' como branch
            const rawUrl = `https://raw.githubusercontent.com/HamletDuFromage/switch-cheats-db/master/cheats/${fileNameJson}`;
            
            try {
                // Habilita o modo de carregamento
                downloadButton.disabled = true;
                statusElement.textContent = 'BUSCANDO CHEATS NO HAMLETDUFROMAGE...';

                const response = await fetch(rawUrl);

                if (response.ok) {
                    const cheatData = await response.json();
                    
                    // Formata o conteúdo
                    const cheatContentText = formatJsonToSwitchCheatTxt(cheatData, gameId); 
                    
                    // Armazena na variável global e exibe o modal
                    currentCheatContent.text = cheatContentText;
                    currentCheatContent.id = gameId;
                    
                    previewTextArea.value = cheatContentText;
                    previewModal.style.display = 'block';
                    
                    statusElement.textContent = `CHEATS ENCONTRADOS. REVISE E CONFIRME NA PRÉ-VISUALIZAÇÃO.`;
                    return true;
                    
                } else if (response.status === 404) {
                    statusElement.textContent = `❌ ERRO: CHEAT PARA O ID ${gameId} NÃO ENCONTRADO. VERIFIQUE O ID.`;
                    return false; 
                } else {
                    statusElement.textContent = `❌ ERRO: FALHA AO BUSCAR CHEAT (STATUS: ${response.status}).`;
                    return false; 
                }
            } catch (error) {
                console.error('Erro de rede ou na operação:', error);
                statusElement.textContent = '❌ ERRO DE CONEXÃO OU REDE. VERIFIQUE SUA INTERNET.';
                return false; 
            } finally {
                downloadButton.disabled = false;
            }
        }

        // Lógica de manipulação do botão
        async function handleDownload() {
            const gameId = inputElement.value.trim().toUpperCase(); 

            // Simples validação de 16 caracteres hexadecimais
            if (gameId.length === 16 && /^[0-9A-F]+$/.test(gameId)) {
                await buscarEVisualizarCheat(gameId);
            } else {
                statusElement.textContent = '⚠️ POR FAVOR, INSIRA UM ID DE 16 CARACTERES HEXADECIMAIS (EX: 0100...).';
                inputElement.focus();
            }
        }
        
        // --- Lógica de Registro do Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Garante que o service worker seja registrado
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('SW registrado com sucesso. Escopo:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha no registro do SW:', error);
                    });
            });
        }
    </script>
</body>
</html>
